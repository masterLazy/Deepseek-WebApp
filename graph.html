<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dsapps | å›¾è®ºåœ¨çº¿ç”»å›¾å·¥å…·</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 0;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-nav {
            width: 100%;
            background: transparent;
            color: #4a69bd;
            padding: 15px 0;
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .nav-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .home-link {
            color: #333333;
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            border-radius: 20px;
            background-color: rgba(102, 102, 102, 0.1);
            transition: background-color 0.3s;
        }

        .home-link:hover {
            background-color: rgba(102, 102, 102, 0.3);
            text-decoration: none;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 20px;
            flex-grow: 1;
        }

        header {
            background: linear-gradient(to right, #6a89cc, #4a69bd);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .description {
            font-size: 0.9rem;
            opacity: 0.9;
            line-height: 1.5;
            max-width: 600px;
            margin: 0 auto;
        }

        .main-content {
            display: flex;
            padding: 0;
            min-height: 600px;
        }

        /* å·¥å…·é¢æ¿ */
        .tool-panel {
            flex: 0 0 340px;
            background: #f9f9f9;
            padding: 20px;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
        }

        /* å›¾å®¹å™¨ */
        .graph-container {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .graph-controls {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }

        /* è¾“å…¥ç»„ */
        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background-color: white;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #6a89cc;
        }

        textarea {
            height: 120px;
            resize: vertical;
            font-family: monospace;
        }

        /* æ¨¡å¼é€‰æ‹©å™¨ */
        .mode-selector {
            display: flex;
            margin-bottom: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .mode-option {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            color: #555;
        }

        .mode-option.active {
            background-color: #6a89cc;
            color: white;
        }

        /* æŒ‰é’® */
        .btn-primary {
            width: 100%;
            padding: 12px;
            background-color: #6a89cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 15px;
        }

        .btn-primary:hover {
            background-color: #5a79bc;
        }

        .btn-secondary {
            padding: 10px 15px;
            background-color: #f5f5f5;
            color: #555;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background-color: #e9e9e9;
        }

        .action-btn {
            background-color: #6a89cc;
            color: white;
        }

        .action-btn:hover {
            background-color: #5a79bc;
        }

        .reset-btn {
            background-color: #e74c3c;
            color: white;
        }

        .reset-btn:hover {
            background-color: #c0392b;
        }

        /* é¢œè‰²æ§åˆ¶ */
        .color-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .color-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-control label {
            min-width: 80px;
            margin: 0;
        }

        /* é¢„è®¾é¢œè‰²é€‰æ‹©å™¨ */
        .preset-colors {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }

        .color-preset {
            width: 25px;
            height: 25px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-preset:hover {
            transform: scale(1.1);
        }

        .color-preset.active {
            border-color: #333;
        }

        /* ä¿¡æ¯æ¡† */
        .info-box {
            background-color: #e8f4fd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1.5px solid #95ade0;
        }

        .info-box h3 {
            color: #4a69bd;
            margin-bottom: 10px;
        }

        .info-box ul {
            margin-left: 10px;
        }

        .instructions {
            background-color: #f0f4ff;
            border-radius: 8px;
            padding: 15px;
            font-size: 0.9rem;
            border-left: 4px solid #6a89cc;
        }

        .instructions h3 {
            margin-bottom: 10px;
            color: #4a69bd;
        }

        .instructions ul {
            padding-left: 20px;
            margin: 10px 0;
        }

        .instructions li {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        /* é€‰ä¸­ä¿¡æ¯ */
        .selected-info {
            margin-top: 10px;
            padding-bottom: 20px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9em;
        }

        /* å›¾åŒºåŸŸ */
        #graph-canvas {
            width: 100%;
            flex: 1;
            min-height: 500px;
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
        }

        .node {
            cursor: move;
        }

        .node-label {
            font-size: 18px;
            font-weight: 700;
            text-anchor: middle;
            pointer-events: none;
            fill: #333333;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .edge-label {
            font-size: 10px;
            text-anchor: middle;
            pointer-events: none;
        }

        /* é¡µè„š */
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
            width: 100%;
        }

        .footer-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .section-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .tool-panel {
                flex: none;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }

            .graph-container {
                min-height: 400px;
            }

            .nav-content {
                flex-direction: column;
                gap: 10px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .description {
                font-size: 1rem;
            }
        }

        .boundary-indicator {
            stroke: #e0e0e0;
            stroke-width: 1;
            fill: none;
            stroke-dasharray: 5, 5;
        }
    </style>
</head>

<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="top-nav">
        <div class="nav-content">
            <div class="nav-title">dsapps</div>
            <a href="https://masterlazy.github.io/dsapps/" class="home-link">
                <span>ğŸ  è¿”å›åº”ç”¨åˆ—è¡¨</span>
            </a>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- å¤´éƒ¨åŒºåŸŸ -->
        <header>
            <h1>å›¾è®ºåœ¨çº¿ç”»å›¾å·¥å…·</h1>
            <p class="description">å¯è§†åŒ–åˆ›å»ºå’Œç¼–è¾‘å›¾ç»“æ„ï¼Œæ”¯æŒæœ‰å‘å›¾å’Œæ— å‘å›¾ï¼Œå¯è‡ªå®šä¹‰èŠ‚ç‚¹å’Œè¾¹çš„é¢œè‰²</p>
        </header>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- å·¥å…·é¢æ¿ -->
            <div class="tool-panel">
                <h2 class="section-title">å›¾ç±»å‹</h2>
                <div class="mode-selector">
                    <div class="mode-option active" id="undirected-btn">æ— å‘å›¾</div>
                    <div class="mode-option" id="directed-btn">æœ‰å‘å›¾</div>
                </div>

                <h2 class="section-title">è¾“å…¥å›¾ç»“æ„</h2>
                <div class="input-group">
                    <textarea id="graph-input" placeholder="è¾“å…¥è¾¹ï¼Œæ¯è¡Œä¸€æ¡ï¼š
1 2
2 3
3 1"></textarea>
                </div>
                <button id="apply-btn" class="btn-primary">åº”ç”¨å›¾ç»“æ„</button>

                <h2 class="section-title">é€‰ä¸­å…ƒç´ é¢œè‰²</h2>
                <div class="selected-info" id="selected-info">
                    ç‚¹å‡»èŠ‚ç‚¹æˆ–è¾¹å¯é€‰ä¸­å¹¶æ›´æ”¹å…¶é¢œè‰²
                </div>
                <div class="color-controls">
                    <div class="color-control">
                        <label>å…ƒç´ é¢œè‰²</label>
                        <div class="preset-colors" id="color-presets">
                            <div class="color-preset active" style="background-color: #333333;" data-color="#333333">
                            </div>
                            <div class="color-preset" style="background-color: #e74c3c;" data-color="#e74c3c"></div>
                            <div class="color-preset" style="background-color: #3498db;" data-color="#3498db"></div>
                            <div class="color-preset" style="background-color: #2ecc71;" data-color="#2ecc71"></div>
                            <div class="color-preset" style="background-color: #f39c12;" data-color="#f39c12"></div>
                            <div class="color-preset" style="background-color: #9b59b6;" data-color="#9b59b6"></div>
                        </div>
                    </div>
                </div>

                <h2 class="section-title">æ“ä½œ</h2>
                <button id="clear-btn" class="btn-primary reset-btn">æ¸…ç©ºç”»å¸ƒ</button>
                <button id="reset-view-btn" class="btn-primary">é‡ç½®è§†å›¾</button>

                <div class="info-box">
                    <h3>ä½¿ç”¨è¯´æ˜</h3>
                    <ul>
                        <li>é€šè¿‡æ–‡æœ¬è¾“å…¥åˆ›å»ºå›¾: æ¯è¡Œè¾“å…¥ä¸€æ¡è¾¹ (å¦‚ "1 2")</li>
                        <li>æ‹–æ‹½èŠ‚ç‚¹å¯ä»¥é‡æ–°å¸ƒå±€</li>
                        <li>ç‚¹å‡»èŠ‚ç‚¹æˆ–è¾¹å¯ä»¥é€‰ä¸­å¹¶æ›´æ”¹å…¶é¢œè‰²</li>
                        <li>åˆ‡æ¢æœ‰å‘å›¾/æ— å‘å›¾æ¨¡å¼</li>
                        <li>ä½¿ç”¨"é‡ç½®è§†å›¾"æŒ‰é’®å¯å°†æ‰€æœ‰èŠ‚ç‚¹é‡æ–°å±…ä¸­</li>
                    </ul>
                </div>
            </div>

            <!-- å›¾å®¹å™¨ -->
            <div class="graph-container">
                <div class="graph-controls">
                    <button id="layout-btn" class="btn-secondary action-btn">è‡ªåŠ¨å¸ƒå±€</button>
                    <button id="export-btn" class="btn-secondary">å¯¼å‡ºä¸ºå›¾ç‰‡</button>
                </div>
                <svg id="graph-canvas"></svg>
            </div>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer>
        <p>dsapps &copy; 2025 masterLazy Â· ç”± DeepSeek å¼€å‘ Â· MIT License</p>
    </footer>

    <script>
        // åˆå§‹åŒ–å˜é‡
        let graphType = 'undirected'; // é»˜è®¤è®¾ç½®ä¸ºæ— å‘å›¾
        let nodes = [];
        let edges = [];
        let nextNodeId = 1;
        let selectedElement = null;
        let selectedElementType = null; // 'node' æˆ– 'edge'
        let currentColor = '#333333';

        // åˆ›å»ºSVGå’ŒåŠ›å¯¼å‘å›¾
        const svg = d3.select('#graph-canvas');
        const width = document.getElementById('graph-canvas').clientWidth;
        const height = document.getElementById('graph-canvas').clientHeight;

        // åˆ›å»ºç¼©æ”¾è¡Œä¸º
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });

        svg.call(zoom);

        // åˆ›å»ºä¸»ç»„
        const g = svg.append('g');

        // æ·»åŠ è¾¹ç•ŒæŒ‡ç¤ºå™¨
        g.append('rect')
            .attr('class', 'boundary-indicator')
            .attr('width', width - 100)
            .attr('height', height - 100)
            .attr('x', 50)
            .attr('y', 50);

        // åˆ›å»ºç®­å¤´æ ‡è®°å®šä¹‰
        const defs = svg.append('defs');

        // åˆ›å»ºç®­å¤´æ ‡è®°
        function createArrowMarker(id, color = '#333333') {
            // ç§»é™¤ç°æœ‰çš„ç‰¹å®šç®­å¤´æ ‡è®°
            defs.selectAll(`#${id}`).remove();

            // åªåœ¨æœ‰å‘å›¾æ¨¡å¼ä¸‹åˆ›å»ºç®­å¤´
            if (graphType === 'directed') {
                const marker = defs.append('marker')
                    .attr('id', id)
                    .attr('viewBox', '0 -5 10 10')
                    .attr('refX', 25)  // è°ƒæ•´ç®­å¤´ä½ç½®
                    .attr('refY', 0)
                    .attr('markerWidth', 6)
                    .attr('markerHeight', 6)
                    .attr('orient', 'auto');

                marker.append('path')
                    .attr('d', 'M0,-5L10,0L0,5')
                    .attr('fill', color);
            }
        }

        // ä¸ºæ‰€æœ‰è¾¹åˆ›å»ºç®­å¤´æ ‡è®°
        function createAllArrowMarkers() {
            edges.forEach((edge, index) => {
                createArrowMarker(`arrowhead-${index}`, edge.color || currentColor);
            });
        }

        // ä¸ºç‰¹å®šè¾¹åˆ›å»ºç®­å¤´æ ‡è®°
        function createEdgeArrowMarker(edge, index) {
            createArrowMarker(`arrowhead-${index}`, edge.color || currentColor);
        }

        // åˆå§‹åˆ›å»ºç®­å¤´æ ‡è®°
        createAllArrowMarkers();

        // åŠ›å¯¼å‘å›¾æ¨¡æ‹Ÿ - ä¼˜åŒ–å‚æ•°é˜²æ­¢èŠ‚ç‚¹åˆ†æ•£
        const simulation = d3.forceSimulation(nodes)
            .force('link', d3.forceLink(edges).id(d => d.id).distance(120))
            .force('charge', d3.forceManyBody()
                .strength(-100)  // å‡å°‘æ’æ–¥åŠ›å¼ºåº¦
                .distanceMax(300)  // è®¾ç½®æœ€å¤§ä½œç”¨è·ç¦»
            )
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(35))
            .force('x', d3.forceX(width / 2).strength(0.05))  // Xè½´ä¸­å¿ƒå¼•åŠ›
            .force('y', d3.forceY(height / 2).strength(0.05)) // Yè½´ä¸­å¿ƒå¼•åŠ›
            .alphaDecay(0.02)  // é™ä½alphaè¡°å‡é€Ÿåº¦ï¼Œä½¿å¸ƒå±€æ›´ç¨³å®š
            .velocityDecay(0.4);  // å¢åŠ é€Ÿåº¦è¡°å‡ï¼Œé˜²æ­¢èŠ‚ç‚¹é£æ•£

        // åˆå§‹åŒ–æ¸²æŸ“
        createDefaultGraph();
        updateGraph();

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('directed-btn').addEventListener('click', () => {
            graphType = 'directed';
            document.getElementById('directed-btn').classList.add('active');
            document.getElementById('undirected-btn').classList.remove('active');
            createAllArrowMarkers();
            updateGraph();
        });

        document.getElementById('undirected-btn').addEventListener('click', () => {
            graphType = 'undirected';
            document.getElementById('undirected-btn').classList.add('active');
            document.getElementById('directed-btn').classList.remove('active');
            // æ— å‘å›¾ä¸éœ€è¦ç®­å¤´æ ‡è®°
            defs.selectAll('marker').remove();
            updateGraph();
        });

        document.getElementById('apply-btn').addEventListener('click', applyGraphInput);
        document.getElementById('clear-btn').addEventListener('click', clearCanvas);
        document.getElementById('layout-btn').addEventListener('click', applyLayout);
        document.getElementById('export-btn').addEventListener('click', exportImage);
        document.getElementById('reset-view-btn').addEventListener('click', resetView);

        // é¢„è®¾é¢œè‰²é€‰æ‹©å™¨äº‹ä»¶
        document.querySelectorAll('#color-presets .color-preset').forEach(preset => {
            preset.addEventListener('click', function () {
                const color = this.getAttribute('data-color');
                currentColor = color;

                // æ›´æ–°é¢„è®¾é¢œè‰²æ¿€æ´»çŠ¶æ€
                document.querySelectorAll('#color-presets .color-preset').forEach(p => p.classList.remove('active'));
                this.classList.add('active');

                updateSelectedElementColor();
            });
        });

        // åˆ›å»ºé»˜è®¤å›¾
        function createDefaultGraph() {
            nodes = [
                { id: '1', label: '1', strokeColor: currentColor, x: width / 2 - 100, y: height / 2 - 50 },
                { id: '2', label: '2', strokeColor: currentColor, x: width / 2 + 100, y: height / 2 - 50 },
                { id: '3', label: '3', strokeColor: currentColor, x: width / 2, y: height / 2 + 50 }
            ];
            edges = [
                { source: '1', target: '2', color: currentColor },
                { source: '2', target: '3', color: currentColor },
                { source: '3', target: '1', color: currentColor }
            ];
            nextNodeId = 4;
        }

        // é‡ç½®è§†å›¾å‡½æ•°
        function resetView() {
            // é‡ç½®ç¼©æ”¾å’Œå¹³ç§»
            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity);

            // å°†æ‰€æœ‰èŠ‚ç‚¹é‡æ–°å±…ä¸­
            nodes.forEach(node => {
                node.x = width / 2;
                node.y = height / 2;
                node.vx = 0;
                node.vy = 0;
            });

            // é‡æ–°å¯åŠ¨æ¨¡æ‹Ÿ
            simulation.alpha(1).restart();
            updateGraph();
        }

        // åº”ç”¨æ–‡æœ¬è¾“å…¥çš„å›¾ç»“æ„
        function applyGraphInput() {
            const input = document.getElementById('graph-input').value.trim();
            if (!input) return;

            // æ¸…ç©ºå½“å‰å›¾
            nodes = [];
            edges = [];
            nextNodeId = 1;

            // è§£æè¾“å…¥
            const lines = input.split('\n');
            const nodeMap = new Map();

            lines.forEach(line => {
                const parts = line.trim().split(/\s+/);
                if (parts.length >= 2) {
                    const sourceId = parts[0];
                    const targetId = parts[1];

                    // ç¡®ä¿èŠ‚ç‚¹å­˜åœ¨
                    if (!nodeMap.has(sourceId)) {
                        nodeMap.set(sourceId, {
                            id: nextNodeId.toString(),
                            label: sourceId,
                            strokeColor: currentColor,
                            x: width / 2 + (Math.random() - 0.5) * 100,
                            y: height / 2 + (Math.random() - 0.5) * 100
                        });
                        nodes.push(nodeMap.get(sourceId));
                        nextNodeId++;
                    }

                    if (!nodeMap.has(targetId)) {
                        nodeMap.set(targetId, {
                            id: nextNodeId.toString(),
                            label: targetId,
                            strokeColor: currentColor,
                            x: width / 2 + (Math.random() - 0.5) * 100,
                            y: height / 2 + (Math.random() - 0.5) * 100
                        });
                        nodes.push(nodeMap.get(targetId));
                        nextNodeId++;
                    }

                    // æ·»åŠ è¾¹
                    edges.push({
                        source: nodeMap.get(sourceId).id,
                        target: nodeMap.get(targetId).id,
                        color: currentColor
                    });
                }
            });

            createAllArrowMarkers();
            updateGraph();
        }

        // æ¸…ç©ºç”»å¸ƒ
        function clearCanvas() {
            nodes = [];
            edges = [];
            nextNodeId = 1;
            selectedElement = null;
            selectedElementType = null;
            document.getElementById('selected-info').textContent = 'ç‚¹å‡»èŠ‚ç‚¹æˆ–è¾¹å¯é€‰ä¸­å¹¶æ›´æ”¹å…¶é¢œè‰²';
            defs.selectAll('marker').remove();
            updateGraph();
        }

        // åº”ç”¨è‡ªåŠ¨å¸ƒå±€
        function applyLayout() {
            simulation.alpha(1).restart();
        }

        // å¯¼å‡ºä¸ºå›¾ç‰‡
        function exportImage() {
            const svgData = new XMLSerializer().serializeToString(svg.node());
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);

            img.onload = function () {
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0);
                URL.revokeObjectURL(url);

                const imageURI = canvas.toDataURL('image/png');
                const downloadLink = document.createElement('a');
                downloadLink.href = imageURI;
                downloadLink.download = 'graph.png';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            };

            img.src = url;
        }

        // æ›´æ–°é€‰ä¸­çš„å…ƒç´ é¢œè‰²
        function updateSelectedElementColor() {
            if (!selectedElement || !selectedElementType) return;

            if (selectedElementType === 'node') {
                selectedElement.strokeColor = currentColor;
                document.getElementById('selected-info').textContent =
                    `å·²é€‰ä¸­èŠ‚ç‚¹ ${selectedElement.label}ï¼Œè½®å»“é¢œè‰²å·²æ›´æ–°`;
            } else if (selectedElementType === 'edge') {
                selectedElement.color = currentColor;

                // æ‰¾åˆ°è¾¹çš„ç´¢å¼•å¹¶æ›´æ–°å¯¹åº”çš„ç®­å¤´æ ‡è®°
                const edgeIndex = edges.findIndex(edge =>
                    edge.source === selectedElement.source &&
                    edge.target === selectedElement.target
                );

                if (edgeIndex !== -1) {
                    createEdgeArrowMarker(selectedElement, edgeIndex);
                }

                document.getElementById('selected-info').textContent =
                    `å·²é€‰ä¸­è¾¹ ${selectedElement.source.label} â†’ ${selectedElement.target.label}ï¼Œé¢œè‰²å·²æ›´æ–°`;
            }

            updateGraph();
        }

        // æ›´æ–°å›¾æ˜¾ç¤º
        function updateGraph() {
            // æ¸…é™¤ç°æœ‰å†…å®¹
            g.selectAll('.edges, .nodes').remove();

            // åˆ›å»ºè¾¹ç»„
            const edgeGroup = g.append('g').attr('class', 'edges');

            // åˆ›å»ºèŠ‚ç‚¹ç»„
            const nodeGroup = g.append('g').attr('class', 'nodes');

            // ç»˜åˆ¶è¾¹
            const edgeSelection = edgeGroup.selectAll('.edge')
                .data(edges, (d, i) => `${d.source.id || d.source}-${d.target.id || d.target}-${i}`);

            const edgeEnter = edgeSelection.enter()
                .append('g')
                .attr('class', 'edge')
                .style('cursor', 'pointer')
                .on('click', function (event, d) {
                    // å–æ¶ˆä¹‹å‰é€‰ä¸­çš„å…ƒç´ 
                    if (selectedElement) {
                        if (selectedElementType === 'node') {
                            nodeGroup.selectAll('.node').select('circle')
                                .attr('stroke-width', 2);
                        } else {
                            edgeGroup.selectAll('.edge').select('line')
                                .attr('stroke-width', 2);
                        }
                    }

                    // é€‰ä¸­å½“å‰è¾¹
                    selectedElement = d;
                    selectedElementType = 'edge';
                    d3.select(this).select('line').attr('stroke-width', 4);

                    document.getElementById('selected-info').textContent =
                        `å·²é€‰ä¸­è¾¹ ${d.source.label || d.source} â†’ ${d.target.label || d.target}`;
                });

            // ç»˜åˆ¶è¾¹çº¿
            edgeEnter.append('line')
                .attr('class', 'edge-line')
                .attr('stroke', d => d.color || currentColor)
                .attr('stroke-width', 2)
                .attr('marker-end', (d, i) => graphType === 'directed' ? `url(#arrowhead-${i})` : null);

            // æ›´æ–°æ‰€æœ‰è¾¹
            const allEdges = edgeSelection.merge(edgeEnter);

            allEdges.select('.edge-line')
                .attr('stroke', d => d.color || currentColor)
                .attr('marker-end', (d, i) => graphType === 'directed' ? `url(#arrowhead-${i})` : null);

            // ç»˜åˆ¶èŠ‚ç‚¹
            const nodeSelection = nodeGroup.selectAll('.node')
                .data(nodes, d => d.id);

            const nodeEnter = nodeSelection.enter()
                .append('g')
                .attr('class', 'node')
                .style('cursor', 'pointer')
                .call(d3.drag()
                    .on('start', dragStarted)
                    .on('drag', dragged)
                    .on('end', dragEnded))
                .on('click', function (event, d) {
                    // å–æ¶ˆä¹‹å‰é€‰ä¸­çš„å…ƒç´ 
                    if (selectedElement) {
                        if (selectedElementType === 'node') {
                            nodeGroup.selectAll('.node').select('circle')
                                .attr('stroke-width', 2);
                        } else {
                            edgeGroup.selectAll('.edge').select('line')
                                .attr('stroke-width', 2);
                        }
                    }

                    // é€‰ä¸­å½“å‰èŠ‚ç‚¹
                    selectedElement = d;
                    selectedElementType = 'node';
                    d3.select(this).select('circle')
                        .attr('stroke-width', 4);

                    document.getElementById('selected-info').textContent =
                        `å·²é€‰ä¸­èŠ‚ç‚¹ ${d.label}`;
                });

            // ç»˜åˆ¶èŠ‚ç‚¹åœ†åœˆ - ç™½è‰²èƒŒæ™¯ï¼Œè½®å»“è‰²å¯è‡ªå®šä¹‰
            nodeEnter.append('circle')
                .attr('r', 22)
                .attr('fill', '#ffffff')  // å›ºå®šç™½è‰²å¡«å……
                .attr('stroke', d => d.strokeColor || currentColor)  // ä½¿ç”¨è½®å»“è‰²
                .attr('stroke-width', 2);

            // æ·»åŠ èŠ‚ç‚¹æ ‡ç­¾ - é»‘è‰²æ–‡å­—
            nodeEnter.append('text')
                .attr('class', 'node-label')
                .attr('dy', 5)
                .text(d => d.label);

            // æ›´æ–°æ‰€æœ‰èŠ‚ç‚¹
            const allNodes = nodeSelection.merge(nodeEnter);

            allNodes.select('circle')
                .attr('fill', '#ffffff')
                .attr('stroke', d => d.strokeColor || currentColor);

            // æ›´æ–°åŠ›å¯¼å‘æ¨¡æ‹Ÿ
            simulation.nodes(nodes);
            simulation.force('link').links(edges);
            simulation.alpha(1).restart();

            // æ›´æ–°èŠ‚ç‚¹å’Œè¾¹çš„ä½ç½®
            simulation.on('tick', () => {
                // æ·»åŠ è¾¹ç•Œçº¦æŸï¼Œé˜²æ­¢èŠ‚ç‚¹é£å‡ºç”»å¸ƒ
                nodes.forEach(d => {
                    d.x = Math.max(30, Math.min(width - 30, d.x));
                    d.y = Math.max(30, Math.min(height - 30, d.y));
                });

                allNodes
                    .attr('transform', d => `translate(${d.x},${d.y})`);

                allEdges.select('.edge-line')
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
            });
        }

        // æ‹–æ‹½å‡½æ•°
        function dragStarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragEnded(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    </script>
</body>

</html>